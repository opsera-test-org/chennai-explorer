name: Bootstrap Infrastructure

on:
  workflow_dispatch:
    inputs:
      aws_region:
        description: 'AWS Region'
        required: true
        default: 'us-west-2'
        type: choice
        options:
          - us-west-2
          - us-east-1
          - eu-west-1

env:
  APP_NAME: chenaiexpo
  TENANT: opsera
  AWS_REGION: ${{ inputs.aws_region || 'us-west-2' }}
  HUB_CLUSTER: argocd-usw2
  SPOKE_CLUSTER: opsera-usw2-np
  ARGOCD_SERVER: argocd-usw2.agent.opsera.dev

jobs:
  bootstrap:
    name: Bootstrap Infrastructure
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
    
    - name: Get AWS Account ID
      id: account
      run: |
        ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
        echo "account_id=$ACCOUNT_ID" >> $GITHUB_OUTPUT
        echo "âœ… AWS Account ID: $ACCOUNT_ID"
    
    - name: Create ECR Repository
      id: ecr
      run: |
        REPO_NAME="${{ env.TENANT }}-${{ env.APP_NAME }}"
        
        # Check if repository exists
        if aws ecr describe-repositories --repository-names $REPO_NAME --region ${{ env.AWS_REGION }} 2>/dev/null; then
          echo "âœ… ECR repository $REPO_NAME already exists"
        else
          echo "Creating ECR repository: $REPO_NAME"
          aws ecr create-repository \
            --repository-name $REPO_NAME \
            --region ${{ env.AWS_REGION }} \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256
          echo "âœ… ECR repository created"
        fi
        
        ECR_URI="${{ steps.account.outputs.account_id }}.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$REPO_NAME"
        echo "ecr_uri=$ECR_URI" >> $GITHUB_OUTPUT
        echo "âœ… ECR URI: $ECR_URI"
    
    - name: Configure kubectl for Hub Cluster
      run: |
        aws eks update-kubeconfig --name ${{ env.HUB_CLUSTER }} --region ${{ env.AWS_REGION }}
        kubectl config use-context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.HUB_CLUSTER }}
        echo "âœ… Connected to hub cluster: ${{ env.HUB_CLUSTER }}"
    
    - name: Create ArgoCD Application (Idempotent)
      run: |
        echo "Creating/Updating ArgoCD Application for dev environment..."
        kubectl apply -f argocd/application-dev.yaml --context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.HUB_CLUSTER }}
        echo "âœ… ArgoCD Application created/updated"
    
    - name: Configure kubectl for Spoke Cluster
      run: |
        aws eks update-kubeconfig --name ${{ env.SPOKE_CLUSTER }} --region ${{ env.AWS_REGION }}
        kubectl config use-context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.SPOKE_CLUSTER }}
        echo "âœ… Connected to spoke cluster: ${{ env.SPOKE_CLUSTER }}"
    
    - name: Create Namespace (Idempotent)
      run: |
        kubectl apply -f k8s/base/namespace.yaml --context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.SPOKE_CLUSTER }}
        echo "âœ… Namespace created/updated"
    
    - name: Refresh ECR Secret on Spoke Cluster
      run: |
        NAMESPACE="opsera-chenaiexpo-dev"
        
        # Get ECR token
        ECR_TOKEN=$(aws ecr get-login-password --region ${{ env.AWS_REGION }})
        
        # Delete existing secret if present
        kubectl delete secret ecr-secret -n $NAMESPACE --context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.SPOKE_CLUSTER }} --ignore-not-found=true
        
        # Create new secret
        kubectl create secret docker-registry ecr-secret \
          --docker-server=${{ steps.ecr.outputs.ecr_uri }} \
          --docker-username=AWS \
          --docker-password=$ECR_TOKEN \
          --namespace=$NAMESPACE \
          --context arn:aws:eks:${{ env.AWS_REGION }}:${{ steps.account.outputs.account_id }}:cluster/${{ env.SPOKE_CLUSTER }}
        
        echo "âœ… ECR secret refreshed on spoke cluster"
    
    - name: Update Kustomization with ECR URI
      run: |
        ECR_URI="${{ steps.ecr.outputs.ecr_uri }}"
        
        # Update base kustomization
        sed -i "s|PLACEHOLDER_ECR_URI|$ECR_URI|g" k8s/base/kustomization.yaml
        
        # Check if changes were made
        if git diff --quiet k8s/base/kustomization.yaml; then
          echo "No changes to commit"
        else
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add k8s/base/kustomization.yaml
          git commit -m "chore: update ECR URI in kustomization [skip ci]"
          git pull --rebase origin main
          git push origin main
          echo "âœ… Kustomization updated with ECR URI"
        fi
    
    - name: Bootstrap Summary
      run: |
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ‰ BOOTSTRAP COMPLETE"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ“¦ Infrastructure Ready:"
        echo "   â€¢ ECR Repository: ${{ steps.ecr.outputs.ecr_uri }}"
        echo "   â€¢ Hub Cluster: ${{ env.HUB_CLUSTER }}"
        echo "   â€¢ Spoke Cluster: ${{ env.SPOKE_CLUSTER }}"
        echo "   â€¢ Namespace: opsera-chenaiexpo-dev"
        echo "   â€¢ ArgoCD Application: chenaiexpo-dev"
        echo ""
        echo "ğŸš€ Next Steps:"
        echo "   1. Trigger the dev-deploy workflow"
        echo "   2. Monitor deployment on ArgoCD: https://${{ env.ARGOCD_SERVER }}"
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
